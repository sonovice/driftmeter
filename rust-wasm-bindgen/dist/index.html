<!doctype html>
<html>
<meta charset="utf-8">
<style>
    body {
        text-align: center;
    }

    canvas {
        border: 1px black solid;
    }
</style>
<body>
<script src="drift_meter.js"></script>
<script src="colormap.js"></script>
<script>
    const {Context} = wasm_bindgen;

    let cx = null;
    wasm_bindgen('./drift_meter_bg.wasm').then(function () {
        cx = Context.new()
    });

    function start() {
        let button = document.getElementById("start");
        button.disabled = true;

        let canvasElement = document.getElementsByTagName("canvas")[0];
        let canvasCtx = canvasElement.getContext("2d");

        const HEIGHT = canvasElement.height;
        const WIDTH = canvasElement.width;

        const SPEED = 2;

        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false,
            }
        }).then(function (stream) {
            let audioSource = audioCtx.createMediaStreamSource(stream);
            let scriptNode = audioCtx.createScriptProcessor(2048, 1, 1);
            scriptNode.onaudioprocess = function (audioProcessingEvent) {
                const inputBuffer = audioProcessingEvent.inputBuffer;

                cx.process_audio(inputBuffer.getChannelData(0));
                const ptr = cx.result_ptr();
                const len = cx.result_len();
                const chroma = new Float32Array(wasm_bindgen.wasm.memory.buffer)
                    .subarray(ptr / 4, ptr / 4 + len);

                const barHeight = HEIGHT / chroma.length;

                canvasCtx.drawImage(canvasElement, -SPEED, 0);
                chroma.forEach(function (value, i) {
                    canvasCtx.fillStyle = float2color(value);
                    let curHeight = HEIGHT - ((i + 1) * barHeight);
                    canvasCtx.fillRect(WIDTH - SPEED, curHeight, SPEED, barHeight);
                });


            };
            audioSource.connect(scriptNode);
            scriptNode.connect(audioCtx.destination);

        }).catch(function (err) {
            console.log('Error initializing user media stream: ' + err);
        });
    }

</script>

<canvas width="600" height="400"></canvas>
<br>
<button id="start" onclick="start()">Start</button>

</body>
</html>