<!doctype html>
<html>
<meta charset="utf-8">
<style>
    body {
        text-align: center;
    }

    canvas {
        border: 1px black solid;
    }
</style>
<body>
<script src="drift_meter.js"></script>
<script src="colormap.js"></script>
<script>
    const {DriftMeter} = wasm_bindgen;
    const OFFSET_QUEUE_LENGTH = 100;

    let driftMeter = null;
    wasm_bindgen('./drift_meter_bg.wasm').then(function () {
        driftMeter = DriftMeter.new(OFFSET_QUEUE_LENGTH);
    });

    function start() {
        let button = document.getElementById("start");
        button.disabled = true;

        let canvasElement = document.getElementsByTagName("canvas")[0];
        let canvasCtx = canvasElement.getContext("2d");

        const HEIGHT = canvasElement.height;
        const WIDTH = canvasElement.width;

        const SPEED = 2;

        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false,
            }
        }).then(function (stream) {
            let audioSource = audioCtx.createMediaStreamSource(stream);
            let scriptNode = audioCtx.createScriptProcessor(driftMeter.fft_window(), 1, 1);
            scriptNode.onaudioprocess = function (audioProcessingEvent) {
                const inputBuffer = audioProcessingEvent.inputBuffer;

                driftMeter.process_audio(inputBuffer.getChannelData(0));
                const ptr = driftMeter.hpcp_ptr() / Float32Array.BYTES_PER_ELEMENT;
                const hpcp = new Float32Array(wasm_bindgen.wasm.memory.buffer)
                    .subarray(ptr, ptr + 12);

                const barHeight = HEIGHT / hpcp.length;

                canvasCtx.drawImage(canvasElement, -SPEED, 0);
                hpcp.forEach(function (value, i) {
                    canvasCtx.fillStyle = float2color(value);
                    let curHeight = HEIGHT - ((i + 1) * barHeight);
                    canvasCtx.fillRect(WIDTH - SPEED, curHeight, SPEED, barHeight);
                });

                canvasCtx.fillStyle = "#AAAAAA";
                canvasCtx.fillRect(WIDTH - SPEED - 1, HEIGHT / 2 - 1, SPEED + 1, 3);

                canvasCtx.fillStyle = "#00FFFF";
                canvasCtx.fillRect(WIDTH - SPEED - 1, HEIGHT - (driftMeter.offset() * HEIGHT) - 1, SPEED + 1, 3);
                canvasCtx.fillStyle = "#FFFF00";
                canvasCtx.fillRect(WIDTH - SPEED - 1, HEIGHT - (driftMeter.offset_mean() * HEIGHT) - 1, SPEED + 1, 3);


            };
            audioSource.connect(scriptNode);
            scriptNode.connect(audioCtx.destination);

        }).catch(function (err) {
            console.log('Error initializing user media stream: ' + err);
        });
    }

</script>

<canvas width="600" height="400"></canvas>
<br>
<button id="start" onclick="start()">Start</button>

</body>
</html>